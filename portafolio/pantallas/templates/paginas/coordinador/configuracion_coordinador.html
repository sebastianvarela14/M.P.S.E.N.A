{% extends "plantillacoor.html" %}

{% block contenido %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Configuración del Coordinador</title>

    <style>
        /* ========= PALETA ========= */
        :root {
            --verde: #2e8b57;
            --verde-oscuro: #1f6b43;
            --verde-claro: #e8f5ee;
            --azul: #1e88e5;
            --rojo: #e53935;
            --gris-fondo: #f5f7f8;
            --gris-borde: #e0e0e0;
            --texto: #2f2f2f;
        }

        body {
            font-family: "Segoe UI", system-ui, sans-serif;
            background-color: var(--gris-fondo);
        }

        header {
            background: linear-gradient(135deg, var(--verde), var(--verde-oscuro));
            color: white;
            padding: 22px;
            text-align: center;
            border-radius: 0 0 18px 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,.18);
        }

        main {
            max-width: 1150px;
            margin: 30px auto;
            background: white;
            padding: 35px;
            border-radius: 18px;
            box-shadow: 0 10px 28px rgba(0,0,0,.12);
        }

        h2 {
            color: var(--verde);
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--verde-claro);
        }

        .explicacion {
            background: var(--verde-claro);
            border-left: 6px solid var(--verde);
            padding: 15px 18px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: var(--texto);
        }

        section {
            margin-bottom: 35px;
        }

        .grupo {
            background: #fff;
            border: 1px solid var(--gris-borde);
            padding: 22px;
            border-radius: 14px;
            transition: box-shadow .2s ease;
        }

        .grupo:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,.08);
        }

        .buscar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 12px;
        }

        .buscar input {
            padding: 8px 12px;
            width: 260px;
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        .opcion {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 6px;
            background: #fafafa;
        }

        .acciones {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 18px;
        }

        button {
            padding: 9px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: .25s;
        }

        .btn-guardar {
            background: var(--verde);
            color: white;
        }
        .btn-guardar:hover { background: var(--verde-oscuro); }

        .btn-anadir {
            background: var(--azul);
            color: white;
        }

        .btn-eliminar {
            background: var(--rojo);
            color: white;
        }

        .lista-guardados {
            border: 1px solid var(--gris-borde);
            border-radius: 14px;
            padding: 18px;
            background: #fdfdfd;
        }

        .lista-guardados h4 {
            margin-top: 0;
            color: var(--verde);
        }

        /* ========= TRIMESTRE ========= */
        .trimestre-info {
            background: #f8fbfa;
            padding: 16px;
            border-radius: 12px;
            border: 1px dashed var(--verde);
            margin-bottom: 18px;
        }

        .sugerencia {
            margin-top: 8px;
            color: var(--verde-oscuro);
            font-weight: 600;
        }

        select.form-control {
            padding: 9px;
            border-radius: 8px;
            border: 1px solid #ccc;

</head>            margin-top: 6px;
        }

        /* ========= MODALES ========= */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.45);
            z-index: 999;
        }

        .modal-contenido {
            background: white;
            margin: 10% auto;
            width: 420px;
            padding: 22px;
            border-radius: 16px;
            box-shadow: 0 10px 24px rgba(0,0,0,.3);
        }

        .modal-header {
            font-weight: 600;
            color: var(--verde);
            margin-bottom: 12px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 18px;
        }

        .cerrar {
            background: #999;
            color: white;
        }

        .trimestre-info {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}
        .trimestre-info p {
            margin: 0;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f9f9f9;
            border: 1px solid var(--gris-borde);
        }
        .trimestre-info .sugerencia {
            background: #ffebee;
            border-left: 4px solid var(--rojo);
            color: var(--rojo-oscuro);
            font-weight: 500;
        }
        .trimestre-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .trimestre-form label {
            font-weight: bold;
            color: var(--verde);
        }
    </style>

<body>
<header>
    <h1>⚙️ Configuración del Coordinador</h1>
</header>

<main>

<div class="explicacion">
    <p><strong>Ficha {{ ficha.numero_ficha }}</strong> — Administración general de instructores, aprendices, asignaturas y trimestre académico.</p>
</div>

<!-- ================= CONFIGURAR TRIMESTRE ================= -->
<section>
    <h2>Configurar Trimestre</h2>
    <div class="explicacion">
        <p>El trimestre actual se usa para guardar archivos en portafolios. Se calcula automáticamente cada 3 meses desde la fecha de inicio de la ficha (máximo {{ max_trimestres }} trimestres para este programa). Puedes cambiarlo manualmente si es necesario.</p>
    </div>

    <div class="grupo">
        <div class="trimestre-info">
            <p><strong>Trimestre actual:</strong> {{ ficha.trimestre_actual }}</p>
            <p><strong>Trimestre sugerido:</strong> {{ trimestre_sugerido }}</p>

            {% if trimestre_sugerido > ficha.trimestre_actual %}
                <p class="sugerencia">
                    ⏳ Ya puedes avanzar al trimestre {{ trimestre_sugerido }}
                </p>
            {% endif %}
        </div>

        <form method="POST" class="trimestre-form">
            {% csrf_token %}
            <input type="hidden" name="accion" value="cambiar_trimestre">

            <label>Seleccionar nuevo trimestre</label>
            <select name="nuevo_trimestre" class="form-control">
                {% for t in trimestres_disponibles %}
                    <option value="{{ t }}" {% if ficha.trimestre_actual == t %}selected{% endif %}>
                        {{ t }}{% if t == 1 %}er{% elif t == 2 %}do{% elif t == 3 %}er{% else %}to{% endif %} Trimestre
                    </option>
                {% endfor %}
            </select>

            <div class="acciones">
                <button type="submit" class="btn-guardar">Guardar Trimestre</button>
            </div>
        </form>
    </div>
</section>

<!-- Estilos adicionales para trimestre (agrega esto al bloque <style> en el <head>) -->



    <!-- Instructores -->
    <section>
        <h2>Asignar Instructores</h2>
        <form method="POST">
            {% csrf_token %}

            <!-- Enviar el ficha_id al backend -->
            <input type="hidden" name="ficha_id" value="{{ ficha_id }}">
            <div class="grupo">
                <div class="buscar">
                    <input type="text" id="buscarInstructor" 
                        onkeyup="filtrar('buscarInstructor','listaInstructores')" 
                        placeholder="Buscar instructor...">
                </div>
                <div id="listaInstructores">
                    {% for ins in instructores %}
                        <div class="opcion">
                            <input type="checkbox"
                                name="instructores"
                                value="{{ ins.id }}"
                                {% if ins.id in ids_instructores_asignados %}checked{% endif %}>
                            {{ ins.nombres }} {{ ins.apellidos }}
                        </div>
                    {% endfor %}
                </div>
                <div class="acciones">
                    <button type="submit" class="btn-guardar">Guardar Instructores</button>

                    <button type="button" class="btn-anadir" 
                        onclick="abrirModal('modalInstructor')">Añadir Instructor</button>
                </div>
            </div>
        </form>
    </section>
    <section>
        <div class="lista-guardados">
            <h4>Instructores en esta ficha</h4>

            {% if instructores_asignados %}
                {% for ins in instructores_asignados %}
                    <div class="opcion" style="justify-content: space-between; margin: 6px 0;">
                        <span>{{ ins.nombres }} {{ ins.apellidos }}</span>
                        <form method="POST" action="{% url 'eliminar_instructor' ins.id ficha_id %}" style="display:inline;">
                            {% csrf_token %}
                            <button class="btn-eliminar">Eliminar</button>
                        </form>
                    </div>
                {% endfor %}
            {% else %}
                <p>No hay instructores asignados.</p>
            {% endif %}
        </div>
    </section>

    <!-- Aprendices -->
<section>
    <h2>Asignar Aprendices</h2>
    <form method="POST">
        {% csrf_token %}

        <!-- Enviar el ficha_id al backend -->
        <input type="hidden" name="ficha_id" value="{{ ficha_id }}">

        <div class="grupo">
            <div class="buscar">
                <input type="text" id="buscarAprendiz" 
                       onkeyup="filtrar('buscarAprendiz','listaAprendices')" 
                       placeholder="Buscar aprendiz...">
            </div>

            <div id="listaAprendices">
                {% for apr in aprendices %}
                    <div class="opcion">
                        <input type="checkbox"
                               name="aprendices"
                               value="{{ apr.id }}"
                               {% if apr.id in ids_aprendices_asignados %}checked{% endif %}>
                        {{ apr.nombres }} {{ apr.apellidos }}
                    </div>
                {% endfor %}
            </div>

            <div class="acciones">
                <button type="submit" class="btn-guardar">Guardar Aprendices</button>

                <button type="button" class="btn-anadir" 
                    onclick="abrirModal('modalAprendiz')">Añadir Aprendiz</button>
            </div>
        </div>
    </form>
</section>

<section>
    <div class="lista-guardados">
        <h4>Aprendices en esta ficha</h4>

        {% if aprendices_asignados %}
            {% for apr in aprendices_asignados %}
                <div class="opcion" style="justify-content: space-between; margin: 6px 0;">
                    <span>{{ apr.nombres }} {{ apr.apellidos }}</span>

                    <form method="POST" action="{% url 'eliminar_aprendiz' apr.id ficha_id %}" style="display:inline;">
                        {% csrf_token %}
                        <button class="btn-eliminar">Eliminar</button>
                    </form>
                </div>
            {% endfor %}
        {% else %}
            <p>No hay aprendices asignados.</p>
        {% endif %}
    </div>
</section>

<!-- Asignar Asignaturas -->
<section>
    <h2>Asignar Asignaturas</h2>
    <form method="POST">
        {% csrf_token %}
        
        <!-- Enviar ficha_id -->
        <input type="hidden" name="ficha_id" value="{{ ficha_id }}">

        <div class="grupo">

            <!-- Buscador -->
            <div class="buscar">
                <input type="text" id="buscarAsignatura"
                       onkeyup="filtrar('buscarAsignatura', 'listaAsignaturas')"
                       placeholder="Buscar asignatura...">
            </div>

            <!-- Lista de asignaturas disponibles -->
            <div id="listaAsignaturas">
                {% for a in todas_asignaturas %}
                    <div class="opcion">
                        <input type="checkbox" name="asignaturas" value="{{ a.id }}"
                           {% if a.id in asignadas_ids %}checked{% endif %}>
                        {{ a.nombre }}
                    </div>
                {% endfor %}
            </div>

            <!-- Acciones -->
            <div class="acciones">
                <button type="submit" class="btn-guardar">
                    Guardar Asignaturas
                </button>

                <button type="button" class="btn-anadir"
                        onclick="abrirModal('modalAsignatura')">
                    Añadir Asignatura
                </button>
            </div>
        </div>
    </form>
</section>

<!-- Asignaturas asignadas -->
<section>
    <div class="lista-guardados">
        <h4>Asignaturas en esta ficha</h4>

        {% if asignaturas_ficha %}
            {% for fa in asignaturas_ficha %}
                <div class="opcion" style="justify-content: space-between; margin: 6px 0;">
                    
                    <!-- nombre de la asignatura dentro de fichaasignatura -->
                    <span>
                        {{ fa.idasignatura.nombre }} 
                        {% if fa.instructor %}
                            - Instructor: {{ fa.instructor.nombres }} {{ fa.instructor.apellidos }}
                        {% else %}
                            - Sin instructor asignado
                        {% endif %}
                    </span>

                    <div style="display: flex; gap: 10px; justify-content: flex-end; align-items: center;">
                        <button type="button" class="btn-anadir"
                            onclick="abrirModalInstructor('{{ fa.idasignatura.id }}', '{{ fa.idasignatura.nombre }}')">
                            Administrar Instructor
                        </button>

                        <form method="POST" action="{% url 'eliminar_asignatura' ficha_id=fa.idficha.id asig_id=fa.idasignatura.id %}" style="display: inline-flex; margin: 0;">
                            {% csrf_token %}
                            <button type="submit" class="btn-eliminar">Eliminar</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p>No hay asignaturas asignadas.</p>
        {% endif %}
    </div>
</section>

</main>

<!-- Modales -->
<div id="modalInstructor" class="modal">
  <div class="modal-contenido">
    <div class="modal-header">Añadir Instructor</div>
    <input type="text" id="usuarioInstructor" class="form-control" placeholder="Usuario del instructor">
    <div class="modal-footer">
      <button class="cerrar" onclick="cerrarModal('modalInstructor')">Cancelar</button>
      <button class="btn-anadir">Añadir</button>
    </div>
  </div>
</div>

<div id="modalAprendiz" class="modal">
  <div class="modal-contenido">
    <div class="modal-header">Añadir Aprendiz</div>
    <input type="text" id="usuarioAprendiz" class="form-control" placeholder="Usuario del aprendiz">
    <div class="modal-footer">
      <button class="cerrar" onclick="cerrarModal('modalAprendiz')">Cancelar</button>
      <button class="btn-anadir">Añadir</button>
    </div>
  </div>
</div>

<div id="modalAsignatura" class="modal">
  <div class="modal-contenido">
    <div class="modal-header">Añadir Asignatura</div>
    <input type="text" id="nombreAsignatura" class="form-control" placeholder="Nombre de la asignatura">
    <input type="text" id="instructorAsignatura" class="form-control" placeholder="Usuario del instructor de la asignatura">
    <div class="modal-footer">
      <button class="cerrar" onclick="cerrarModal('modalAsignatura')">Cancelar</button>
      <button class="btn-anadir">Añadir</button>
    </div>
  </div>
</div>

<div id="modalInstructorAsignatura" class="modal">
    <div class="modal-contenido">
        <div class="modal-header">
            Asignar Instructor a:<span id="nombreAsignaturaModal"></span>
        </div>

        <form method="POST" id="formInstructorAsignatura" action="{% url 'asignar_instructor_asignatura' %}">
            {% csrf_token %}
            <input type="hidden" name="ficha_id" value="{{ ficha.id }}">
            <input type="hidden" name="asignatura_id" id="asignaturaIdInput">

            <select name="instructor_id" class="form-control" required>
                {% if instructores_asignados %}
                    <option value="" selected disabled>Seleccione un instructor</option>
                    {% for ins in instructores_asignados %}
                        <option value="{{ ins.id }}"
                            {% if fa.instructor and fa.instructor.id == ins.id %}selected{% endif %}>
                            {{ ins.nombres }} {{ ins.apellidos }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="" disabled selected>No hay instructores asignados</option>
                {% endif %}
            </select>

            <div class="modal-footer">
                <button type="button" class="cerrar" onclick="cerrarModal('modalInstructorAsignatura')">Cancelar</button>
                <button type="submit" class="btn-anadir">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById("formInstructor").addEventListener("submit", function (e) {
    e.preventDefault(); // Evita recarga instantánea
    
    const form = this;
    const modal = bootstrap.Modal.getInstance(document.getElementById("modalInstructor"));

    // Enviar el formulario por AJAX
    fetch("", {
        method: "POST",
        body: new FormData(form)
    })
    .then(response => {
        // cerrar modal
        modal.hide();

        // Opcional: recargar para ver cambios
        setTimeout(() => {
            location.reload();
        }, 400);
    });
});
</script>
<script>
function filtrar(inputId, listaId) {
    let input = document.getElementById(inputId).value.toLowerCase();
    let lista = document.getElementById(listaId).getElementsByClassName('opcion');
    for (let i = 0; i < lista.length; i++) {
        let texto = lista[i].textContent.toLowerCase();
        lista[i].style.display = texto.includes(input) ? "" : "none";
    }
}
function abrirModal(id) { document.getElementById(id).style.display = "block"; }
function cerrarModal(id) { document.getElementById(id).style.display = "none"; }
function abrirModalInstructor(asigId, nombre) {
    document.getElementById('asignaturaIdInput').value = asigId;
    document.getElementById('nombreAsignaturaModal').innerText = nombre;
    abrirModal('modalInstructorAsignatura');
}
</script>
</body>
</html>
{% endblock %}